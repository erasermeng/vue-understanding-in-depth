<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第一个小里程碑 | 深入理解Vue.js</title>
    <meta name="description" content="市面上最清晰的Vue原理分析教程，辅以最新版本的源码分析。">
    <link rel="icon" href="/vue-understanding-in-depth/logo.png">
    
    <link rel="preload" href="/vue-understanding-in-depth/assets/css/0.styles.4eceb7ae.css" as="style"><link rel="preload" href="/vue-understanding-in-depth/assets/js/app.b6288055.js" as="script"><link rel="preload" href="/vue-understanding-in-depth/assets/js/6.dd06b756.js" as="script"><link rel="prefetch" href="/vue-understanding-in-depth/assets/js/2.234811cb.js"><link rel="prefetch" href="/vue-understanding-in-depth/assets/js/3.00e15de7.js"><link rel="prefetch" href="/vue-understanding-in-depth/assets/js/4.faec1237.js"><link rel="prefetch" href="/vue-understanding-in-depth/assets/js/5.98ebf188.js"><link rel="prefetch" href="/vue-understanding-in-depth/assets/js/7.318cc044.js"><link rel="prefetch" href="/vue-understanding-in-depth/assets/js/8.d5987fe7.js">
    <link rel="stylesheet" href="/vue-understanding-in-depth/assets/css/0.styles.4eceb7ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-understanding-in-depth/" class="home-link router-link-active"><!----> <span class="site-name">深入理解Vue.js</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-understanding-in-depth/history/naive_implementation.html" class="nav-link">开始阅读</a></div> <a href="https://github.com/erasermeng/vue-understanding-in-depth" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-understanding-in-depth/history/naive_implementation.html" class="nav-link">开始阅读</a></div> <a href="https://github.com/erasermeng/vue-understanding-in-depth" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>追寻历史的脚步</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/vue-understanding-in-depth/history/naive_implementation.html" class="sidebar-link">玩具级实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#最简单的-vue-实现版本" class="sidebar-link">最简单的 Vue 实现版本</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#最初的想法" class="sidebar-link">最初的想法</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#初步实现思路" class="sidebar-link">初步实现思路</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#指令解析" class="sidebar-link">指令解析</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#binding-实现" class="sidebar-link">binding 实现</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#基本指令实现" class="sidebar-link">基本指令实现</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/naive_implementation.html#基本过滤器实现" class="sidebar-link">基本过滤器实现</a></li></ul></li><li><a href="/vue-understanding-in-depth/history/first_milestone.html" class="active sidebar-link">第一个小里程碑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/first_milestone.html#html-结构" class="sidebar-link">HTML 结构</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/first_milestone.html#启动器设计" class="sidebar-link">启动器设计</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/first_milestone.html#sd-controller-的实现" class="sidebar-link">sd-controller 的实现</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/first_milestone.html#sd-each-的实现" class="sidebar-link">sd-each 的实现</a></li><li class="sidebar-sub-header"><a href="/vue-understanding-in-depth/history/first_milestone.html#更清晰的主调用流程" class="sidebar-link">更清晰的主调用流程</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h2 id="html-结构"><a href="#html-结构" aria-hidden="true" class="header-anchor">#</a> HTML 结构</h2> <p>让我们将历史 check 到<code>83665f99</code>，该提交被作者命名为<code>milestone reached</code>，可以看做是一次小的里程碑。
在这个版本的设计中，HTML 结构设计更为丰富：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sd-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TodoList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sd-on</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click:changeMessage | delegate .button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">sd-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>msg | capitalize<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">sd-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>msg | uppercase<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">sd-on</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click:remove<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>bye<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">sd-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>total | money<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Change Message<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">sd-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>red:error<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sd-show</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>error<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Error<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">sd-show</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todos<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name">sd-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Todo<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name">sd-each</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo:todos<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name">sd-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>done:todo.done<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name">sd-on</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click:changeMessage, click:todo.toggle<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name">sd-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo.title<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以看到，相比于第一次提交，这个版本实现了比较有标志性的两个指令：</p> <ul><li>sd-controller</li> <li>sd-each</li></ul> <h2 id="启动器设计"><a href="#启动器设计" aria-hidden="true" class="header-anchor">#</a> 启动器设计</h2> <p>在这个版本中，Vue 模仿了 Angular 的 API，设计了 bootstrap 方法，作为整个框架的入口：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> app <span class="token operator">=</span> Seed<span class="token punctuation">.</span><span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  el<span class="token punctuation">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> data
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其实现也非常的简单，核心逻辑是对 Seed 进行实例化，兼容支持数组传参调用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Seed<span class="token punctuation">.</span><span class="token function-variable function">bootstrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>seeds<span class="token punctuation">)</span><span class="token punctuation">)</span> seeds <span class="token operator">=</span> <span class="token punctuation">[</span>seeds<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> instances <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  seeds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> el <span class="token operator">=</span> seed<span class="token punctuation">.</span>el<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;invalid element or selector: &quot;</span> <span class="token operator">+</span> seed<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    instances<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Seed</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> seed<span class="token punctuation">.</span>data<span class="token punctuation">,</span> seed<span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> instances<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> instances <span class="token punctuation">:</span> instances<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="sd-controller-的实现"><a href="#sd-controller-的实现" aria-hidden="true" class="header-anchor">#</a> sd-controller 的实现</h2> <p><code>sd-controller</code>的实现在这个版本中非常简单，在整个 Seed 实例被初始化时，会检测该 root 元素上是否有指令：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// if has controller</span>
<span class="token keyword">var</span> ctrlID <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>ctrlAttr<span class="token punctuation">)</span><span class="token punctuation">,</span>
  controller <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ctrlID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  controller <span class="token operator">=</span> controllers<span class="token punctuation">[</span>ctrlID<span class="token punctuation">]</span><span class="token punctuation">;</span>
  el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>ctrlAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>controller<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;controller &quot;</span> <span class="token operator">+</span> ctrlID <span class="token operator">+</span> <span class="token string">&quot; is not defined.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果有指令，且该指令已经被定义，则在整个 binding 初始化完成后，调用该指令的绑定方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// copy in methods from controller</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  controller<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上述 HTML 为例，在根元素上定义了<code>sd-controller</code>：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sd-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TodoList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sd-on</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click:changeMessage | delegate .button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>且在实例化前定义了该 Controller：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Seed<span class="token punctuation">.</span><span class="token function">controller</span><span class="token punctuation">(</span><span class="token string">&quot;TodoList&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>scope<span class="token punctuation">,</span> seed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;controller invoked&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scope<span class="token punctuation">.</span><span class="token function-variable function">changeMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    scope<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;% awesomeness&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  scope<span class="token punctuation">.</span><span class="token function-variable function">remove</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    seed<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>则在整个 scope 初始化完成后，回调该 Controller 的定义方法，在这里对 scope 里的方法进行赋值定义，即可触发对应 binding 的 Setter，从而触发指令的更新。</p> <p>经观察我们还可以发现，上述结构中还有一处调用<code>sd-controller</code>的地方：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Todo<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-each</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo:todos<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>done:todo.done<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-on</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click:changeMessage, click:todo.toggle<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo.title<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在这个版本中，只实现了对根元素的 controller 绑定，那么这里的 Controller 又是什么意思呢？接下来我们需要在复杂的<code>sd-each</code>指令中寻找答案。</p> <h2 id="sd-each-的实现"><a href="#sd-each-的实现" aria-hidden="true" class="header-anchor">#</a> sd-each 的实现</h2> <p>对于 sd-each 指令的支持，在节点的 compile 过程中，会进行单独的逻辑处理：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>eachExp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// each block</span>

  <span class="token keyword">var</span> binding <span class="token operator">=</span> bindingParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>eachAttr<span class="token punctuation">,</span> eachExp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>binding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span><span class="token function">_bind</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> binding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// need to set each block now so it can inherit</span>
    <span class="token comment">// parent scope. i.e. the childSeeds must have been</span>
    <span class="token comment">// initiated when parent scope setters are invoked</span>
    self<span class="token punctuation">.</span>scope<span class="token punctuation">[</span>binding<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>_dataCopy<span class="token punctuation">[</span>binding<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> self<span class="token punctuation">.</span>_dataCopy<span class="token punctuation">[</span>binding<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，首先和其他指令一样，对指令进行 parse 和 bind 操作，最后直接对 scope 进行赋值触发 Setter，从而触发指令的 update 方法，原因如注释所写，在触发 update 时会初始化 each 指令的所有 childSeeds。</p> <p>接下来看看指令的实现，首先被调用的是 bind 方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  bind<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>prefix <span class="token operator">+</span> <span class="token string">&quot;-each&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>prefixRE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">&quot;^&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arg <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> ctn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>marker <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createComment</span><span class="token punctuation">(</span><span class="token string">&quot;sd-each-&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arg <span class="token operator">+</span> <span class="token string">&quot;-marker&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctn<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>marker<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctn<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childSeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在 bind 方法里面，主要做了两件事：</p> <ul><li>生成了一个列表变量的前缀正则</li> <li>插入了一条 marker 注释节点，移除了本身 DOM</li></ul> <p>初看这里的逻辑似乎有些迷惑，让我们接着看下 update 方法做了什么事，因为 update 也紧接着 bind 被触发：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  update<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childSeeds<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>childSeeds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>childSeeds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">watchArray</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mutate<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    collection<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>childSeeds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">buildItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> i<span class="token punctuation">,</span> collection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;collection creation done.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在 update 时，首先 destroy 已有的子元素（childSeeds），然后调用 buildItem 方法生成新的列表，对于数组的 watch 暂且不论，在这个版本中 mutate 方法尚不完善。</p> <p>触发 update 的时机，实际上是当我们把数组对象赋给 each 指令的 key 的时候，这时有可能是二次赋值，所以需要先销毁之前创建的所有子类。</p> <p>接下来看看 buildItem 方法实现：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  buildItem<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> index<span class="token punctuation">,</span> collection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> Seed <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./seed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> spore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Seed</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      eachPrefixRE<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prefixRE<span class="token punctuation">,</span>
      parentSeed<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>seed
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>marker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    collection<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> spore<span class="token punctuation">.</span>scope<span class="token punctuation">;</span>
    <span class="token keyword">return</span> spore<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>buildItem 看似不好理解，实际上只是新建了一个 Seed 实例，并将原节点深拷贝了一份，插入到 Mark 节点前。</p> <p>此时可以回答 build 的第一个问题，为什么要生成一条注释节点呢？
注释节点的作用是一条基准线，数组中的每一项初始化完毕后，都生成一个 node 节点，insertBefore 至 mark 节点前，保证重新插入的顺序。</p> <p>那么 build 中 prefixRE 的作用是什么呢？首先我们来看看调用处的数据格式：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>todos<span class="token punctuation">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&quot;hello!&quot;</span><span class="token punctuation">,</span>
    done<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&quot;hello!!&quot;</span><span class="token punctuation">,</span>
    done<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token string">&quot;hello!!!&quot;</span><span class="token punctuation">,</span>
    done<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Todo<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-each</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo:todos<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>done:todo.done<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-on</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>click:changeMessage, click:todo.toggle<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">sd-text</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>todo.title<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>注意 each 指令<code>todo:todos</code>的写法，实际上作者想要用这样的写法，做到该元素后续可以用<code>todo</code>来取到数组子元素的数据，并同时兼具响应式绑定，因此针对每一个子元素，都重新实例化了一个 Seed 对象，重新解析并绑定。但是，我们注意到在初始化时，传入的数据对象是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  title<span class="token punctuation">:</span> <span class="token string">&quot;hello!!&quot;</span><span class="token punctuation">,</span>
  done<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么如何在其他指令中使用<code>todo.title</code>这样的格式访问呢？这就是 prefixRE 做的事情，在进行 binding 之前，Vue 会检测正则：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> key <span class="token operator">=</span> bindingInstance<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
  epr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>eachPrefixRE<span class="token punctuation">,</span>
  isEachKey <span class="token operator">=</span> epr <span class="token operator">&amp;&amp;</span> epr<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>
  scopeOwner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token comment">// TODO make scope chain work on nested controllers</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isEachKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  key <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>epr<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>epr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scopeOwner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">.</span>parentSeed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果 binding 的 key 匹配到了该正则，则会把<code>todo.</code>这样的字符全部置空，这样再进行绑定时就是首层数据了。
另外，如果没匹配到，但收到了这个正则，这个时候有可能需要访问的是父 scope 数据，所以我们将 scope 设置为父元素。</p> <p>这样，<code>sd-on=&quot;click:changeMessage, click:todo.toggle&quot;</code>这个指令才可以访问的到<code>changeMessage</code>方法，它是定义在父 Seed 的 scope 中的。</p> <h2 id="更清晰的主调用流程"><a href="#更清晰的主调用流程" aria-hidden="true" class="header-anchor">#</a> 更清晰的主调用流程</h2> <p>在这一个 commit 之前，作者经过了多次重构调整，明确各模块的职责归属，获得了一个较为明晰的调用流程：</p> <p><img src="/vue-understanding-in-depth/assets/img/first_milestone.5d0d1fe0.png" alt="更清晰的主调用流程"></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/2/2018, 6:51:57 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/vue-understanding-in-depth/history/naive_implementation.html" class="prev">
          玩具级实现
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/vue-understanding-in-depth/assets/js/6.dd06b756.js" defer></script><script src="/vue-understanding-in-depth/assets/js/app.b6288055.js" defer></script>
  </body>
</html>
